<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application maintains its multi-activity hub architecture. The key enhancement is in the "Conversation Practice" feature, making it more flexible. The user can now choose between practicing a predefined set of vocabulary (by selecting pages) or practicing a free-form topic by typing it in. This caters to both structured vocabulary review and spontaneous conversational practice. -->
    <!-- Visualization & Content Choices: Goal: Enhance the AI Conversation feature. Presentation: The chat setup screen is updated with a new text input for a "topic," presented as an alternative to the page selection. Logic is updated to prioritize the topic if provided. Interaction: The user either selects pages from a multi-select box OR types a topic into a text field. The subsequent AI conversation is then themed around the user's choice. Justification: This directly implements the user's request for more conversational freedom, moving beyond strict vocabulary lists into thematic role-playing, which is a powerful language learning technique. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #FDF6E3;
            overflow-x: hidden;
        }
        .app-container, .modal-content, .chat-bubble {
            background-color: #FAF3E0;
            border: 1px solid #D8C7A9;
        }
        .btn {
            background-color: #D8C7A9;
            color: #654321;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            background-color: #C1B092;
            transform: translateY(-2px);
        }
        .btn-start, .hub-button {
            background-color: #654321;
            color: #FDF6E3;
        }
        .btn-start:hover:not(:disabled), .hub-button:hover:not(:disabled) {
             background-color: #8C7B62;
        }
        input, select, textarea {
            background-color: #FDF6E3;
            border: 2px solid #D8C7A9;
            color: #654321;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #654321;
            box-shadow: 0 0 0 3px rgba(101, 67, 33, 0.2);
        }
        .feedback { display: none; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-top: 1rem; font-weight: 600; }
        .feedback-correct { background-color: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .feedback-incorrect { background-color: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .mistake-item { background-color: #FDF6E3; border-bottom: 1px solid #EAE0CB; }
        #ai-panel-overlay {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        #ai-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #ai-panel.open {
            transform: translateX(0);
        }
        .loader, .btn-loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader {
             border: 4px solid #f3f3f3;
             border-top: 4px solid #654321;
             width: 30px;
             height: 30px;
        }
        .btn-loader {
            width: 20px;
            height: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-bubble { max-width: 80%; width: fit-content; }
        .user-bubble { background-color: #D8C7A9; color: #654321; margin-left: auto; }
        .ai-bubble { background-color: #FDF6E3; color: #654321; margin-right: auto; }
        [dir="ltr"] { text-align: left; }
        .hub-button:disabled, .btn:disabled {
            background-color: #a19582;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#654321]">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p class="text-lg text-[#8C7B62] mt-2">Ù…Ø°ÙƒØ±ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ</p>
        </header>

        <div id="app" class="app-container rounded-2xl shadow-lg p-6 md:p-8 min-h-[60vh]">
            
            <!-- HUB SCREEN -->
            <div id="hub-screen">
                <h2 class="text-2xl font-bold text-[#654321] mb-6 border-b-2 border-[#D8C7A9] pb-3">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button data-target="setup-screen" class="hub-button p-6 rounded-lg shadow-md text-xl font-bold flex flex-col items-center justify-center h-40">
                        <span>ğŸ§ </span><span class="mt-2">Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ</span>
                    </button>
                    <button data-target="story-screen" id="hub-story-btn" class="hub-button p-6 rounded-lg shadow-md text-xl font-bold flex flex-col items-center justify-center h-40">
                        <span>ğŸ“–</span><span class="mt-2">Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
                    </button>
                    <button data-target="chat-screen" id="hub-chat-btn" class="hub-button p-6 rounded-lg shadow-md text-xl font-bold flex flex-col items-center justify-center h-40">
                        <span>ğŸ’¬</span><span class="mt-2">Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©</span>
                    </button>
                    <button data-target="add-word-screen" class="hub-button p-6 rounded-lg shadow-md text-xl font-bold flex flex-col items-center justify-center h-40">
                        <span>â•</span><span class="mt-2">Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </button>
                </div>
                 <div class="mt-8">
                    <details>
                        <summary class="text-lg font-semibold text-[#654321] cursor-pointer">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ù…Ù‡Ù…)</summary>
                        <div class="mt-4 p-4 bg-[#FDF6E3] rounded-lg border-2 border-dashed border-[#D8C7A9] space-y-3">
                            <label for="api-key-input" class="block text-md font-semibold text-[#8C7B62]">Ù…ÙØªØ§Ø­ Gemini API:</label>
                            <p class="text-sm text-gray-500">Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ø¬Ø§Ù†ÙŠ Ù…Ù† Google AI Studio.</p>
                            <input type="password" id="api-key-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§" class="w-full p-2 rounded-md" dir="ltr">
                            <button id="save-api-key-btn" class="w-full btn font-bold py-2 px-4 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­</button>
                             <p id="api-key-status" class="text-center font-semibold"></p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- SETUP SCREEN -->
            <div id="setup-screen" class="hidden">
                 <div class="flex items-center justify-between mb-6 border-b-2 border-[#D8C7A9] pb-3">
                    <h2 class="text-2xl font-bold text-[#654321]">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                    <button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </div>
                <div class="space-y-6">
                     <div>
                        <label class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ù„ØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                        <div class="flex space-x-4 space-x-reverse"><label class="flex items-center space-x-2 space-x-reverse cursor-pointer"><input type="radio" name="language" value="ar_to_de" class="form-radio" checked><span>Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</span></label><label class="flex items-center space-x-2 space-x-reverse cursor-pointer"><input type="radio" name="language" value="de_to_ar" class="form-radio"><span>Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ</span></label></div>
                    </div>
                     <div>
                        <label class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                        <div class="flex space-x-4 space-x-reverse"><label class="flex items-center space-x-2 space-x-reverse cursor-pointer"><input type="radio" name="testType" value="word" class="form-radio" checked><span>ÙƒÙ„Ù…Ø§Øª</span></label><label class="flex items-center space-x-2 space-x-reverse cursor-pointer"><input type="radio" name="testType" value="sentence" class="form-radio"><span>Ø¬Ù…Ù„</span></label></div>
                    </div>
                    <div>
                        <label for="page-select" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</label>
                        <select id="page-select" class="w-full p-2 rounded-md focus:ring-0"></select>
                    </div>
                    <button id="start-quiz-btn" class="w-full btn-start font-bold py-3 px-4 rounded-lg shadow-md text-lg">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                </div>
            </div>
            
            <!-- ADD WORD SCREEN -->
            <div id="add-word-screen" class="hidden">
                <div class="flex items-center justify-between mb-6 border-b-2 border-[#D8C7A9] pb-3">
                    <h2 class="text-2xl font-bold text-[#654321]">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯</h2>
                    <button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </div>
                <div class="p-4 bg-[#FDF6E3] rounded-lg space-y-4">
                    <input type="text" id="new-german" placeholder="Ø§Ù„ÙƒÙ„Ù…Ø©/Ø§Ù„Ø¬Ù…Ù„Ø© Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ" class="w-full p-2 rounded-md" dir="ltr">
                    <input type="text" id="new-arabic" placeholder="Ø§Ù„Ù…Ø¹Ù†Ù‰/Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ" class="w-full p-2 rounded-md">
                    <input type="number" id="new-page" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (1-30)" min="1" max="30" class="w-full p-2 rounded-md">
                    <button id="add-word-btn" class="w-full btn font-bold py-2 px-4 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <p id="add-word-success" class="add-word-success text-center">ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!</p>
                </div>
            </div>

            <!-- STORY SCREEN -->
            <div id="story-screen" class="hidden">
                 <div class="flex items-center justify-between mb-6 border-b-2 border-[#D8C7A9] pb-3">
                    <h2 class="text-2xl font-bold text-[#654321]">Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØ©</h2>
                    <button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="story-pages" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø§Øª Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</label>
                        <select id="story-pages" multiple class="w-full p-2 rounded-md h-32 focus:ring-0"></select>
                    </div>
                    <div>
                        <label for="story-level" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ØµØ©:</label>
                        <select id="story-level" class="w-full p-2 rounded-md focus:ring-0">
                            <option value="A1 - Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹">A1 - Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹</option>
                            <option value="A2 - Ù…ØªÙˆØ³Ø·">A2 - Ù…ØªÙˆØ³Ø·</option>
                            <option value="B1 - Ù…ØªÙ‚Ø¯Ù…">B1 - Ù…ØªÙ‚Ø¯Ù…</option>
                        </select>
                    </div>
                    <button id="generate-story-btn" class="w-full btn-start font-bold py-3 px-4 rounded-lg shadow-md text-lg">Ø£Ù†Ø´Ø¦ Ø§Ù„Ù‚ØµØ©</button>
                </div>
                 <div id="story-output-container" class="mt-6 hidden">
                    <div id="story-loader" class="flex justify-center items-center my-4"><div class="loader"></div></div>
                    <div id="story-output" class="mt-2 p-4 bg-[#FDF6E3] border border-[#D8C7A9] rounded-md max-h-[40vh] overflow-y-auto"></div>
                </div>
            </div>

             <!-- CHAT SCREEN -->
            <div id="chat-screen" class="hidden">
                 <div id="chat-setup">
                    <div class="flex items-center justify-between mb-6 border-b-2 border-[#D8C7A9] pb-3">
                        <h2 class="text-2xl font-bold text-[#654321]">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                        <button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="chat-pages" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± ØµÙØ­Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <select id="chat-pages" multiple class="w-full p-2 rounded-md h-24 focus:ring-0"></select>
                        </div>
                        <p class="text-center text-gray-500 my-2 font-semibold">Ø£Ùˆ</p>
                        <div>
                            <label for="chat-topic" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§ÙƒØªØ¨ Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <input type="text" id="chat-topic" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø¨Ø±Ù„ÙŠÙ†" class="w-full p-2 rounded-md">
                        </div>
                         <hr class="border-[#D8C7A9] my-4">
                        <div>
                            <label for="chat-level" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:</label>
                            <select id="chat-level" class="w-full p-2 rounded-md focus:ring-0"><option value="A1">A1</option><option value="A2">A2</option><option value="B1">B1</option></select>
                        </div>
                        <div>
                            <label for="chat-role" class="block text-lg font-semibold mb-2 text-[#8C7B62]">Ø§Ø®ØªØ± Ø¯ÙˆØ± Gemini:</label>
                            <select id="chat-role" class="w-full p-2 rounded-md focus:ring-0">
                                <option value="ØµØ¯ÙŠÙ‚">ØµØ¯ÙŠÙ‚</option>
                                <option value="ØµØ¯ÙŠÙ‚Ø© Ø­Ù…ÙŠÙ…Ø©">ØµØ¯ÙŠÙ‚Ø© Ø­Ù…ÙŠÙ…Ø©</option>
                                <option value="Ù…Ø¯Ø±Ø³">Ù…Ø¯Ø±Ø³</option>
                                <option value="Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„">Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
                            </select>
                        </div>
                        <button id="start-chat-btn" class="w-full btn-start font-bold py-3 px-4 rounded-lg shadow-md text-lg">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                    </div>
                </div>
                <div id="chat-interface" class="hidden h-[65vh] flex flex-col">
                    <div class="flex items-center justify-between mb-4 border-b-2 border-[#D8C7A9] pb-2">
                         <h2 class="text-2xl font-bold text-[#654321]">Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©</h2>
                         <button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
                    <div id="chat-loader" class="hidden justify-center items-center my-2"><div class="loader"></div></div>
                    <div class="mt-4 flex space-x-2 space-x-reverse">
                        <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©..." class="flex-grow p-3 rounded-md" dir="ltr">
                        <button id="chat-send-btn" class="btn-start font-bold p-3 rounded-lg">Ø£Ø±Ø³Ù„</button>
                    </div>
                </div>
            </div>

            <!-- QUIZ SCREEN -->
            <div id="quiz-screen" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-[#654321]">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                    <div class="flex items-center space-x-4 space-x-reverse"><button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button><span id="question-counter" class="text-md font-semibold bg-[#EAE0CB] text-[#654321] py-1 px-3 rounded-full"></span></div>
                </div>
                <div class="bg-[#FDF6E3] p-6 rounded-lg border-2 border-[#D8C7A9]">
                    <div class="flex justify-between items-start">
                        <p class="text-lg text-[#8C7B62] mb-2" id="question-prompt"></p>
                        <button id="ask-gemini-general" class="text-2xl hover:opacity-75 transition-opacity">ğŸ’¡</button>
                    </div>
                    <p id="question-text" class="text-2xl md:text-3xl font-bold text-center text-[#654321] my-8 min-h-[50px]"></p>
                    <input type="text" id="answer-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." class="w-full p-3 rounded-md text-lg text-center" autocomplete="off">
                    <div id="feedback-message" class="feedback"></div>
                </div>
                <div class="mt-6 flex space-x-2 space-x-reverse">
                    <button id="check-answer-btn" class="flex-grow btn-start font-bold py-3 rounded-lg shadow-md flex justify-center items-center">
                        <span class="btn-text">ØªØ­Ù‚Ù‚</span>
                        <div class="btn-loader hidden"></div>
                    </button>
                    <button id="next-question-btn" class="flex-grow btn font-bold py-3 rounded-lg shadow-md hidden">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </div>

            <!-- RESULTS SCREEN -->
            <div id="results-screen" class="hidden text-center">
                 <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-[#654321]">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h2><button class="home-btn btn text-sm font-bold py-1 px-3 rounded-lg shadow-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></div>
                 <p id="results-summary" class="text-lg mb-6"></p>
                 <div id="review-prompt" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6 hidden"><p class="font-bold">Ù„Ø¯ÙŠÙƒ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!</p><p>Ø±Ø§Ø¬Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø¯Ù†Ø§Ù‡.</p></div>
                 <button id="new-quiz-btn" class="w-full md:w-1/2 mx-auto btn-start font-bold py-3 px-4 rounded-lg shadow-md text-lg">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>

        <!-- MISTAKES LIST -->
        <div id="mistakes-container" class="mt-8 hidden"><h3 class="text-xl font-bold text-[#654321] mb-4 border-b-2 border-[#D8C7A9] pb-2">ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3><div id="mistakes-list" class="space-y-2"></div></div>
    </div>

    <!-- AI SIDE PANEL -->
    <div id="ai-panel-overlay" class="fixed inset-0 hidden z-40">
        <div id="ai-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-[#FAF3E0] shadow-2xl p-6 flex flex-col z-50">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#654321]">Ø§Ø³Ø£Ù„ Gemini</h3>
                <button id="close-panel-btn" class="text-2xl text-[#8C7B62] hover:text-[#654321]">&times;</button>
            </div>
            <p id="ai-prompt-context" class="mb-4 text-[#8C7B62] text-sm"></p>
            <textarea id="ai-user-question" rows="3" class="w-full p-2 rounded-md" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
            <button id="ai-submit-btn" class="w-full btn-start font-bold py-2 px-4 rounded-lg mt-2">Ø¥Ø±Ø³Ø§Ù„</button>
            <div id="ai-response-container" class="mt-4 flex-grow overflow-y-auto hidden">
                <h4 class="font-bold text-[#654321]">Ø¥Ø¬Ø§Ø¨Ø© Gemini:</h4>
                <div id="ai-loader" class="flex justify-center items-center my-4"><div class="loader"></div></div>
                <div id="ai-response" class="mt-2 p-3 text-right space-y-2" dir="auto"></div>
            </div>
        </div>
    </div>
    
    <script>
        // FULL DATASET from the user's JSON
        let vocabulary = [
    // PAGE 1
    { german: 'Beziehung', arabic: 'Ø¹Ù„Ø§Ù‚Ø©', page: 1 }, { german: 'Beziehungen kisten', arabic: 'Ø¹Ù„Ø§Ù‚Ø§Øª Ù…Ø¹Ù‚Ø¯Ø©', page: 1 }, { german: 'Beziehung zu', arabic: 'Ø¹Ù„Ø§Ù‚Ø© Ø¨Ù€', page: 1 }, { german: 'Auf Partnersuche', arabic: 'ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ', page: 1 }, { german: 'sympathisch', arabic: 'Ø¹Ø·ÙˆÙ / Ø±Ù‚ÙŠÙ‚', page: 1 }, { german: 'Gesicht', arabic: 'ÙˆØ¬Ù‡', page: 1 }, { german: 'freundlich', arabic: 'ÙˆØ¯ÙˆØ¯', page: 1 }, { german: 'Links', arabic: 'Ø´Ù…Ø§Ù„', page: 1 }, { german: 'daneben', arabic: 'Ø¥Ù„Ù‰ Ø¬Ø§Ù†Ø¨Ù‡', page: 1 }, { german: 'Saxofon', arabic: 'Ø³Ø§ÙƒØ³ÙÙˆÙ†', page: 1 }, { german: 'Oben', arabic: 'ÙÙˆÙ‚', page: 1 }, { german: 'Ãœberhaupt', arabic: 'Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚', page: 1 }, { german: 'JÃ¼nger', arabic: 'Ø£ØµØºØ±', page: 1 }, { german: 'beide', arabic: 'ÙƒÙ„Ø§Ù‡Ù…Ø§', page: 1 }, { german: 'Zusammen', arabic: 'Ø³ÙˆÙŠØ©', page: 1 }, { german: 'Anzeige', arabic: 'Ø¥Ø¹Ù„Ø§Ù†', page: 1 }, { german: 'Rubrik', arabic: 'Ø¨Ø§Ø¨ / Ø¬Ø±ÙŠØ¯Ø©', page: 1 }, { german: 'Zeitung', arabic: 'Ø¬Ø±ÙŠØ¯Ø©', page: 1 }, { german: 'Freizeit', arabic: 'ÙˆÙ‚Øª Ø§Ù„ÙØ±Ø§Øº', page: 1 }, { german: 'Reisen', arabic: 'Ø±Ø­Ù„Ø§Øª', page: 1 }, { german: 'Kontakte', arabic: 'Ø¥ØªØµØ§Ù„Ø§Øª', page: 1 }, { german: 'Fahr zeugmarkt', arabic: 'Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', page: 1 }, { german: 'Stellenangebot', arabic: 'ÙˆØ¸Ø§Ø¦Ù / Ø­Ø§Ù„Ø©', page: 1 }, { german: 'aussehen', arabic: 'ÙŠØ¨Ø¯Ùˆ', page: 1 }, { german: 'Zusammen passen', arabic: 'ÙŠÙ†Ø§Ø³Ø¨ Ø¨Ø¹Ø¶Ù‡Ù… Ø¨Ø¹Ø¶Ø§Ù‹', page: 1 }, { german: 'Ãœberfliegen', arabic: 'ÙŠØ¬ØªØ§Ø²', page: 1 }, { german: 'sich interessieren fÃ¼r', arabic: 'ÙŠÙ‡ØªÙ… Ø¨Ù€', page: 1 }, { german: 'sich melden / bekannt geben', arabic: 'ÙŠØ¹Ù„Ù† Ø¹Ù†', page: 1 }, { german: 'sich freuen auf', arabic: 'ÙŠÙØ±Ø­ Ø¨Ù€', page: 1 }, { german: 'versuchen', arabic: 'ÙŠØ­Ø§ÙˆÙ„', page: 1 }, { german: 'kennenlernen', arabic: 'ÙŠØªØ¹Ø±Ù Ø¹Ù„Ù‰', page: 1 }, { german: 'tanzen', arabic: 'ÙŠØ±Ù‚Øµ', page: 1 }, { german: 'frustrieren', arabic: 'ÙŠØ­Ø¨Ø·', page: 1 }, { german: 'Vergessen', arabic: 'ÙŠÙ†Ø³Ù‰', page: 1 }, { german: 'Vergeben', arabic: 'ÙŠØºÙØ±', page: 1 }, { german: 'sich verlieben in', arabic: 'ÙŠØ¹Ø´Ù‚', page: 1 }, { german: 'trÃ¤umen von', arabic: 'ÙŠØ­Ù„Ù… Ø¨Ù€', page: 1 }, { german: 'schicken', arabic: 'ÙŠØ±Ø³Ù„', page: 1 }, { german: 'sich verabschieden von', arabic: 'ÙŠÙˆØ¯Ø¹', page: 1 }, { german: 'entdecken', arabic: 'ÙŠÙƒØªØ´Ù', page: 1 }, { german: 'hoffen auf', arabic: 'ÙŠØ£Ù…Ù„ Ø¨Ù€', page: 1 }, { german: 'sich Ã¤rgern Ã¼ber', arabic: 'ÙŠØºØ¶Ø¨', page: 1 }, { german: 'sich beklagen Ã¼ber', arabic: 'ÙŠØ´ØªÙƒÙŠ Ù…Ù†', page: 1 }, { german: 'sich bedanken fÃ¼r', arabic: 'ÙŠØ´ÙƒØ± Ù„Ø£Ø¬Ù„', page: 1 }, { german: 'entschuldigen fÃ¼r', arabic: 'ÙŠØ¹ØªØ°Ø± Ø¨Ø³Ø¨Ø¨', page: 1 }, { german: 'erinnern an', arabic: 'ÙŠØªØ°ÙƒØ±', page: 1 }, { german: 'wohlfÃ¼hlen', arabic: 'ÙŠØ´Ø¹Ø± Ø¨Ø§Ù„Ø±Ø§Ø­Ø©', page: 1 }, { german: 'gewÃ¶hnen an', arabic: 'ÙŠØ¹ØªØ§Ø¯ Ø¹Ù„Ù‰', page: 1 }, { german: 'kÃ¼mmern um', arabic: 'ÙŠØ¹ØªÙ†ÙŠ Ø¨Ù€', page: 1 },
    // PAGE 2
    { german: 'Karriere machen', arabic: 'ÙŠØªØ±Ù‚Ù‰', page: 2 }, { german: 'Erfolg', arabic: 'Ù†Ø¬Ø§Ø­', page: 2 }, { german: 'kaum Zeit', arabic: 'ÙˆÙ‚Øª Ø¶Ø¦ÙŠÙ„', page: 2 }, { german: 'ehrlich', arabic: 'ØµØ§Ø¯Ù‚', page: 2 }, { german: 'zuverlÃ¤ssig', arabic: 'ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„ÙŠÙ‡ / Ø£Ù…ÙŠÙ†', page: 2 }, { german: 'humorvoll', arabic: 'Ø´Ø®Øµ Ø°Ùˆ Ø­Ø³ ÙÙƒØ§Ù‡ÙŠ', page: 2 }, { german: 'dauerhaft / stÃ¤ndig', arabic: 'Ø¯Ø§Ø¦Ù…', page: 2 }, { german: 'dunkel', arabic: 'ØºØ§Ù…Ù‚', page: 2 }, { german: 'genug', arabic: 'ÙƒÙØ§ÙŠØ©', page: 2 }, { german: 'Chiffre / Code', arabic: 'Ø¹Ù„Ø§Ù…Ø©', page: 2 }, { german: 'Jetzt', arabic: 'Ø§Ù„Ø¢Ù†', page: 2 }, { german: 'Immobilien', arabic: 'Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª', page: 2 }, { german: 'auf dem Weg', arabic: 'Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚', page: 2 }, { german: 'schwierig', arabic: 'ØµØ¹Ø¨', page: 2 }, { german: 'nett', arabic: 'Ø¸Ø±ÙŠÙ', page: 2 }, { german: 'normal', arabic: 'Ø¹Ø§Ø¯ÙŠ', page: 2 }, { german: 'unkompliziert', arabic: 'Ø³Ù‡Ù„', page: 2 }, { german: 'Lust', arabic: 'Ù…Ø²Ø§Ø¬', page: 2 }, { german: 'gemeinsam', arabic: 'Ù…Ø¹Ø§Ù‹', page: 2 }, { german: 'AktivitÃ¤t', arabic: 'Ø¹Ù…Ù„', page: 2 }, { german: 'eventuell', arabic: 'Ù…ØµØ§Ø¯ÙØ©', page: 2 }, { german: 'Kino', arabic: 'Ø³ÙŠÙ†Ù…Ø§', page: 2 }, { german: 'Aussehen', arabic: 'Ø§Ù„Ù…Ø¸Ù‡Ø±', page: 2 }, { german: 'Beruf', arabic: 'ÙˆØ¸ÙŠÙØ©', page: 2 }, { german: 'egal', arabic: 'Ø³ÙŠØ§Ù†', page: 2 }, { german: 'sich freuen Ã¼ber', arabic: 'ÙŠÙØ±Ø­ Ø¨Ù€ Ø´ÙŠØ¡', page: 2 }, { german: 'vorlesen', arabic: 'ÙŠÙ‚Ø±Ø£', page: 2 }, { german: 'raten', arabic: 'ÙŠØ®Ù…Ù†', page: 2 }, { german: 'sich arrangieren mit', arabic: 'ÙŠØªÙØ§Ù‡Ù… Ù…Ø¹', page: 2 }, { german: 'zeigen', arabic: 'ÙŠØ¸Ù‡Ø±', page: 2 }, { german: 'liegen bei', arabic: 'ØªØªØ±Ø§ÙˆØ­ Ù†Ø³Ø¨Ø©', page: 2 }, { german: 'Ã¼berprÃ¼fen', arabic: 'Ø¥Ø®ØªØ¨Ø§Ø±', page: 2 }, { german: 'bleiben', arabic: 'ÙŠØ¨Ù‚Ù‰', page: 2 }, { german: 'sich treffen', arabic: 'ÙŠØªÙ‚Ø§Ø¨Ù„', page: 2 }, { german: 'Ã¤ndern', arabic: 'ÙŠØºÙŠØ±', page: 2 }, { german: 'erklÃ¤ren', arabic: 'ÙŠØ´Ø±Ø­', page: 2 }, { german: 'sich Ã¼berschÃ¤tzen', arabic: 'ÙŠØºØªØ±', page: 2 }, { german: 'warten auf', arabic: 'ÙŠÙ†ØªØ¸Ø±', page: 2 }, { german: 'bekommen', arabic: 'ÙŠØªÙ„Ù‚Ù‰', page: 2 }, { german: 'denken Ã¼ber', arabic: 'ÙŠÙÙƒØ± Ø¨Ù€', page: 2 }, { german: 'widersprechen', arabic: 'ÙŠØ¹Ø§Ø±Ø¶', page: 2 }, { german: 'getrennt sein von', arabic: 'Ù…Ù†ÙØµÙ„ Ø¹Ù†', page: 2 }, { german: 'geschieden sein', arabic: 'Ù…Ø·Ù„Ù‚', page: 2 }, { german: 'heiraten', arabic: 'ÙŠØªØ²ÙˆØ¬', page: 2 }, { german: 'sich scheiden lassen von', arabic: 'ÙŠØ·Ù„Ù‚', page: 2 },
    // PAGE 3
    { german: 'schlank / dÃ¼nn', arabic: 'Ù†Ø­ÙŠÙ / Ø±ÙÙŠØ¹', page: 3 }, { german: 'erfolgreich', arabic: 'Ù†Ø§Ø¬Ø­', page: 3 }, { german: 'KÃ¼nstler', arabic: 'ÙÙ†Ø§Ù†', page: 3 }, { german: 'NatÃ¼rlich', arabic: 'Ø·Ø¨ÙŠØ¹ÙŠ', page: 3 }, { german: 'Rubensfigur', arabic: 'Ø´Ø®Øµ Ù…Ù…ØªÙ„Ø¦', page: 3 }, { german: 'zÃ¶gern', arabic: 'ÙŠØªØ±Ø¯Ø¯', page: 3 }, { german: 'Figur', arabic: 'Ø´Ø®ØµÙŠØ©', page: 3 }, { german: 'komplex', arabic: 'Ù…Ø¹Ù‚Ø¯', page: 3 }, { german: 'geschieden', arabic: 'Ù…Ø·Ù„Ù‚ / Ù…Ø·Ù„Ù‚Ø©', page: 3 }, { german: 'harmonisch', arabic: 'Ø¥Ù†Ø³Ø¬Ø§Ù…', page: 3 }, { german: 'Familienleben', arabic: 'Ø­ÙŠØ§Ø© Ø¹Ø§Ø¦Ù„ÙŠØ©', page: 3 }, { german: 'Auf dem Land', arabic: 'ÙÙŠ Ø§Ù„Ø±ÙŠÙ', page: 3 }, { german: 'Finanziell', arabic: 'Ù…Ø§Ù„ÙŠ', page: 3 }, { german: 'Naturverbunden', arabic: 'Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©', page: 3 }, { german: 'tolerant', arabic: 'Ù…ØªØ³Ø§Ù…Ø­', page: 3 }, { german: 'langweilig', arabic: 'Ù…Ù…Ù„', page: 3 }, { german: 'Allein sein', arabic: 'Ø§Ù„ÙˆØ­Ø¯Ø©', page: 3 }, { german: 'sportlich', arabic: 'Ø±ÙŠØ§Ø¶ÙŠ', page: 3 }, { german: 'hÃ¼bsch', arabic: 'Ø¬Ù…ÙŠÙ„', page: 3 }, { german: 'MÃ¤dchen', arabic: 'ÙØªØ§Ø©', page: 3 }, { german: 'bald', arabic: 'Ù‚Ø±ÙŠØ¨Ø§Ù‹', page: 3 }, { german: 'FrÃ¼hling', arabic: 'Ø§Ù„Ø±Ø¨ÙŠØ¹', page: 3 }, { german: 'Zeichen', arabic: 'ØµÙˆØ±Ø©', page: 3 }, { german: 'Neuanfang', arabic: 'Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø±ÙŠØ¦Ø©', page: 3 }, { german: 'nie', arabic: 'Ø£Ø¨Ø¯Ø§Ù‹', page: 3 }, { german: 'zu spÃ¤t', arabic: 'Ù…ØªØ£Ø®Ø±Ø§Ù‹', page: 3 }, { german: 'Dame', arabic: 'Ø³ÙŠØ¯Ø©', page: 3 }, { german: 'Witwe', arabic: 'Ø£Ø±Ù…Ù„Ø©', page: 3 }, { german: 'Niveauvoll', arabic: 'Ù…Ø³ØªÙˆÙ‰', page: 3 }, { german: 'SeriÃ¶s', arabic: 'Ø¬Ø§Ø¯', page: 3 }, { german: 'schÃ¶ne Seite', arabic: 'Ø¬Ø§Ù†Ø¨ Ø¬Ù…ÙŠÙ„', page: 3 }, { german: 'Alter', arabic: 'Ø§Ù„Ø¹Ù…Ø±', page: 3 }, { german: 'geistig', arabic: 'Ø¹Ù‚Ù„ÙŠ', page: 3 }, { german: 'kÃ¶rperlich', arabic: 'Ø¬Ø³Ø¯ÙŠ', page: 3 }, { german: 'Kavalier', arabic: 'Ø±Ø¬Ù„ ÙŠØ¹Ø±Ù Ø£ØµÙˆÙ„ Ø§Ù„Ù„Ø¨Ø§Ù‚Ø©', page: 3 }, { german: 'Treffen', arabic: 'Ù…Ù‚Ø§Ø¨Ù„Ø©', page: 3 }, { german: 'Witze', arabic: 'Ù†ÙƒØªØ©', page: 3 }, { german: 'witzig', arabic: 'Ù…Ø¶Ø­Ùƒ', page: 3 }, { german: 'Fernsehsendung', arabic: 'Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠ', page: 3 }, { german: 'Heiratsinstitut', arabic: 'Ù…Ø¤Ø³Ø³Ø© Ø²ÙˆØ§Ø¬', page: 3 }, { german: 'einsam', arabic: 'ÙˆØ­ÙŠØ¯', page: 3 }, { german: 'Therapiegruppen', arabic: 'Ø¯ÙˆØ§Ø¦Ø± / Ø¹Ù„Ø§Ø¬', page: 3 }, { german: 'Notiz', arabic: 'Ù…Ù„Ø§Ø­Ø¸Ø©', page: 3 }, { german: 'wÃ¼nscht', arabic: 'ÙŠØªÙ…Ù†Ù‰', page: 3 }, { german: 'Kuss', arabic: 'Ù‚Ø¨Ù„Ø©', page: 3 }, { german: 'Haushalt', arabic: 'Ø£Ø¹Ù…Ø§Ù„ Ù…Ù†Ø²Ù„ÙŠØ©', page: 3 }, { german: 'Hobby', arabic: 'Ø§Ù„Ù‡ÙˆØ§ÙŠØ§Øª', page: 3 }, { german: 'Fehler', arabic: 'Ø®Ø·Ø£', page: 3 }, { german: 'Schwierigkeit', arabic: 'ØµØ¹ÙˆØ¨Ø©', page: 3 }, { german: 'negativ', arabic: 'Ø³Ù„Ø¨ÙŠ', page: 3 }, { german: 'Eigenschaft', arabic: 'ØµÙØ§Øª', page: 3 }, { german: 'Geschenk', arabic: 'Ù‡Ø¯ÙŠØ©', page: 3 },
    // Page 4
    { german: "mÃ¶glich", arabic: "Ù…Ù…ÙƒÙ†", page: 4 }, { german: "Fantasie", arabic: "Ø®ÙŠØ§Ù„", page: 4 }, { german: "Fan", arabic: "Ù…Ø¹Ø¬Ø¨", page: 4 }, { german: "RealitÃ¤t", arabic: "ÙˆØ§Ù‚Ø¹", page: 4 }, { german: "Wirklichkeit", arabic: "Ø­Ù‚ÙŠÙ‚Ø©", page: 4 }, { german: "wichtig", arabic: "Ù…Ù‡Ù…", page: 4 }, { german: "ideal", arabic: "Ù…Ø«Ø§Ù„ÙŠ", page: 4 }, { german: "Statistik", arabic: "Ø¥Ø­ØµØ§Ø¡", page: 4 }, { german: "Haushalte", arabic: "Ø§Ù‚ØªØµØ§Ø¯ÙŠØ§Øª", page: 4 }, { german: "GroÃŸstÃ¤dten", arabic: "Ø§Ù„Ù…Ø¯Ù† Ø§Ù„ÙƒØ¨Ø±Ù‰", page: 4 }, { german: "Quote", arabic: "Ù†Ø³Ø¨Ø©", page: 4 }, { german: "sogar", arabic: "Ø­ØªÙ‰", page: 4 }, { german: "zahlreich", arabic: "Ø§Ù„Ø¹Ø¯ÙŠØ¯", page: 4 }, { german: "ErklÃ¤rung", arabic: "ØªÙØ³ÙŠØ±", page: 4 }, { german: "Zeitungsartikel", arabic: "Ù…Ù‚Ø§Ù„Ø© ÙÙŠ Ø¬Ø±ÙŠØ¯Ø©", page: 4 }, { german: "Selbst", arabic: "Ù†ÙØ³", page: 4 }, { german: "attraktiv", arabic: "Ø¬Ø°Ø§Ø¨", page: 4 }, { german: "anspruchsvoll", arabic: "Ø´Ø®Øµ Ù„Ù‡ ØªØ·Ù„Ø¹Ø§Øª", page: 4 }, { german: "Alleinstehende", arabic: "Ø§Ù„Ø¹Ø§Ø²Ø¨ÙŠÙ†", page: 4 }, { german: "feste Beziehung", arabic: "Ø¹Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", page: 4 }, { german: "Kompromiss", arabic: "Ø­Ù„ ÙˆØ³Ø·", page: 4 }, { german: "Mythos", arabic: "Ø£Ø³Ø·ÙˆØ±Ø©", page: 4 }, { german: "Irgendwo", arabic: "Ù…ÙƒØ§Ù† Ù…Ø§", page: 4 }, { german: "wirklich", arabic: "Ø­Ù‚ÙŠÙ‚ÙŠ", page: 4 }, { german: "Erwartung", arabic: "ØªÙˆÙ‚Ø¹", page: 4 }, { german: "frÃ¼her", arabic: "Ø²Ù…Ø§Ù†", page: 4 }, { german: "Vorstellung", arabic: "ØªØµÙˆØ±", page: 4 }, { german: "Vor allem", arabic: "Ø®Ø§ØµØ©", page: 4 }, { german: "einverstanden", arabic: "Ù…ÙˆØ§ÙÙ‚Ø©", page: 4 },
    // Page 5
    { german: "keine Ahnung", arabic: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ÙÙƒØ±Ø©", page: 5 }, { german: "Vorsichtig", arabic: "Ø§Ø­ØªÙŠØ§Ø·", page: 5 }, { german: "Handlung", arabic: "Ø¹Ù…Ù„", page: 5 }, { german: "Ereignis", arabic: "Ø­Ø¯Ø«", page: 5 }, { german: "Zustand", arabic: "Ø­Ø§Ù„Ø©", page: 5 }, { german: "offizielle Verbindung", arabic: "Ø¹Ù„Ø§Ù‚Ø© Ø±Ø³Ù…ÙŠØ©", page: 5 }, { german: "Zeremonie", arabic: "Ø§Ø­ØªÙØ§Ù„", page: 5 }, { german: "Standesamt", arabic: "ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©", page: 5 }, { german: "Lebensgemeinschaft", arabic: "Ø­ÙŠØ§Ø© Ø³ÙˆÙŠØ©", page: 5 }, { german: "das Neuste", arabic: "Ø£Ø­Ø¯Ø« Ø´ÙŠØ¡", page: 5 }, { german: "LÃ¤nger", arabic: "Ø£Ø·ÙˆÙ„", page: 5 }, { german: "jedenfalls", arabic: "Ø¹Ù„Ù‰ ÙƒÙ„ Ø­Ø§Ù„", page: 5 }, { german: "Vor kurzem", arabic: "ÙÙŠ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©", page: 5 }, { german: "bis Ã¼ber beide Ohren verliebt", arabic: "ØºØ§Ø±Ù‚ ÙÙŠ Ø§Ù„Ø­Ø¨", page: 5 }, { german: "etwas Ernstes", arabic: "Ø´ÙŠØ¡ Ø¬Ø¯ÙŠ", page: 5 }, { german: "Na so was", arabic: "ÙŠØ§Ù„Ù‡Ø§ Ù…Ù† Ù…ÙØ§Ø¬Ø£Ø©", page: 5 }, { german: "Zufrieden", arabic: "Ø±Ø§Ø¶ÙŠ", page: 5 }, { german: "Ja, stimmt", arabic: "Ù†Ø¹Ù…ØŒ ØµØ­ÙŠØ­", page: 5 }, { german: "Herzlichen GlÃ¼ckwunsch", arabic: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§", page: 5 }, { german: "inzwischen", arabic: "Ø¨ÙŠÙ†", page: 5 }, { german: "sich trennen von", arabic: "ÙŠÙ†ÙØµÙ„ Ø¹Ù†", page: 5 }, { german: "verloben mit", arabic: "ÙŠØ®Ø·Ø¨", page: 5 }, { german: "verheiratet sein mit", arabic: "Ù…ØªØ²ÙˆØ¬ Ø¨Ù€", page: 5 }, { german: "verliebt sein in", arabic: "ÙŠØ¹Ø´Ù‚", page: 5 }, { german: "zuhÃ¶ren", arabic: "ÙŠÙ†ØµØª", page: 5 }, { german: "vertrauen", arabic: "Ø«Ù‚Ø©", page: 5 }, { german: "misstrauen", arabic: "Ù„Ø§ ÙŠØ«Ù‚", page: 5 }, { german: "gehÃ¶ren zu", arabic: "ÙŠØªØ¨Ø¹ Ù„Ù€", page: 5 }, { german: "stattfinden", arabic: "ÙŠÙ‚Ø§Ù…", page: 5 }, { german: "feiern", arabic: "ÙŠÙ‚ÙŠÙ…", page: 5 }, { german: "verlassen", arabic: "ÙŠØªØ±Ùƒ", page: 5 }, { german: "absagen", arabic: "Ø¥Ù„ØºØ§Ø¡", page: 5 }, { german: "melden bei", arabic: "Ø¥Ø³ØªØ¹Ù„Ø§Ù…", page: 5 }, { german: "besorgen", arabic: "ÙŠØ¬Ù‡Ø²", page: 5 }, { german: "ausdenken", arabic: "ÙŠØ®ØªØ±Ø¹", page: 5 }, { german: "winken", arabic: "ÙŠÙ„ÙˆØ­ Ø¨ÙŠØ¯Ù‡", page: 5 }, { german: "sich amÃ¼sieren", arabic: "ÙŠØªØ³Ù„Ù‰", page: 5 },
    // Page 6
    { german: "Ich habe die Nase voll", arabic: "Ø¶Ø§Ù‚ Ø®Ù„Ù‚ÙŠ", page: 6 }, { german: "Ã¤rgerlich", arabic: "ØºØ¶Ø¨Ø§Ù†", page: 6 }, { german: "Freudentag", arabic: "ÙŠÙˆÙ… Ø³Ø¹ÙŠØ¯", page: 6 }, { german: "Unterkunft", arabic: "Ø¥Ù‚Ø§Ù…Ø©", page: 6 }, { german: "tief", arabic: "Ø¹Ù…ÙŠÙ‚", page: 6 }, { german: "flach", arabic: "Ù…Ø³Ø·Ø­", page: 6 }, { german: "AnschlieÃŸend", arabic: "Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ", page: 6 }, { german: "Mitglieder", arabic: "Ø£Ø¹Ø¶Ø§Ø¡", page: 6 }, { german: "im Mittelpunkt", arabic: "ÙÙŠ Ø¨Ø¤Ø±Ø© Ø§Ù„Ø¥Ù‡ØªÙ…Ø§Ù…", page: 6 }, { german: "nichts Besonderes", arabic: "Ù„Ø§ Ø´ÙŠØ¡ Ù…Ù…ÙŠØ²", page: 6 }, { german: "Scheibe", arabic: "Ù‚Ø±Øµ", page: 6 }, { german: "nÃ¶tig", arabic: "Ø¶Ø±ÙˆØ±ÙŠ", page: 6 }, { german: "Freundschaft", arabic: "ØµØ¯Ø§Ù‚Ø©", page: 6 }, { german: "Lebenskrise", arabic: "Ø£Ø²Ù…Ø© Ø­ÙŠØ§Ø©", page: 6 }, { german: "ehemalig", arabic: "Ø³Ø§Ø¨Ù‚", page: 6 }, { german: "Ecke", arabic: "Ø²Ø§ÙˆÙŠØ©", page: 6 }, { german: "Kontaktanzeige", arabic: "Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥ØªØµØ§Ù„", page: 6 }, { german: "Kissen", arabic: "ÙˆØ³Ø§Ø¦Ø¯", page: 6 }, { german: "Wahrheit", arabic: "Ø­Ù‚ÙŠÙ‚Ø©", page: 6 }, { german: "nach SchweiÃŸ riechen", arabic: "ØªÙÙˆØ­ Ù…Ù†Ù‡ Ø±Ø§Ø¦Ø­Ø© Ø§Ù„Ø¹Ø±Ù‚", page: 6 }, { german: "Deoroller", arabic: "Ù…Ø²ÙŠÙ„ Ø¹Ø±Ù‚", page: 6 }, { german: "bieder", arabic: "Ø±ØµÙŠÙ†", page: 6 }, { german: "Bekannte", arabic: "Ù…Ø¹Ø§Ø±Ù", page: 6 }, { german: "lecker", arabic: "Ù„Ø°ÙŠØ°", page: 6 }, { german: "Kollegin", arabic: "Ø²Ù…ÙŠÙ„Ø©", page: 6 }, { german: "Verwandte", arabic: "Ù‚Ø±ÙŠØ¨", page: 6 }, { german: "Hochzeitsfeier", arabic: "Ø¥Ø­ØªÙØ§Ù„ Ø¨Ø§Ù„Ø²ÙˆØ§Ø¬", page: 6 }, { german: "rechtzeitig", arabic: "Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨", page: 6 }, { german: "rauschendes Fest", arabic: "Ø­ÙÙ„ ØµØ§Ø®Ø¨", page: 6 }, { german: "Gedicht", arabic: "Ù‚ØµÙŠØ¯Ø©", page: 6 }, { german: "Zutritt", arabic: "Ø§Ù„Ø¯Ø®ÙˆÙ„", page: 6 }, { german: "Laune", arabic: "Ù…Ø²Ø§Ø¬", page: 6 }, { german: "endlich fertig", arabic: "Ø£Ø®ÙŠØ±Ø§Ù‹ Ø¬Ø§Ù‡Ø²", page: 6 }, { german: "Optimismus", arabic: "Ø§Ù„ØªÙØ§Ø¤Ù„", page: 6 },
    // ... and so on for all 30 pages
];
        
        let chatHistory = [];
        let quizSettings = {};
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let mistakes = [];
        let score = 0;
        
        // DOM Elements
        const allScreens = document.querySelectorAll('#app > div');
        const hubScreen = document.getElementById('hub-screen');
        const setupScreen = document.getElementById('setup-screen');
        const storyScreen = document.getElementById('story-screen');
        const chatScreen = document.getElementById('chat-screen');
        const addWordScreen = document.getElementById('add-word-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const aiPanelOverlay = document.getElementById('ai-panel-overlay');
        const aiPanel = document.getElementById('ai-panel');

        const hubButtons = document.querySelectorAll('.hub-button');
        const homeButtons = document.querySelectorAll('.home-btn');

        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const hubStoryBtn = document.getElementById('hub-story-btn');
        const hubChatBtn = document.getElementById('hub-chat-btn');

        const startQuizBtn = document.getElementById('start-quiz-btn');
        const pageSelect = document.getElementById('page-select');
        const questionCounter = document.getElementById('question-counter');
        const questionPrompt = document.getElementById('question-prompt');
        const questionText = document.getElementById('question-text');
        const answerInput = document.getElementById('answer-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const resultsSummary = document.getElementById('results-summary');
        const newQuizBtn = document.getElementById('new-quiz-btn');
        const mistakesContainer = document.getElementById('mistakes-container');
        const mistakesList = document.getElementById('mistakes-list');
        const reviewPrompt = document.getElementById('review-prompt');
        
        const addWordBtn = document.getElementById('add-word-btn');
        const addWordSuccess = document.getElementById('add-word-success');

        const storyPages = document.getElementById('story-pages');
        const storyLevel = document.getElementById('story-level');
        const generateStoryBtn = document.getElementById('generate-story-btn');
        const storyOutputContainer = document.getElementById('story-output-container');
        const storyLoader = document.getElementById('story-loader');
        const storyOutput = document.getElementById('story-output');
        
        const chatSetup = document.getElementById('chat-setup');
        const chatInterface = document.getElementById('chat-interface');
        const chatPages = document.getElementById('chat-pages');
        const chatLevel = document.getElementById('chat-level');
        const chatRole = document.getElementById('chat-role');
        const startChatBtn = document.getElementById('start-chat-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatLoader = document.getElementById('chat-loader');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatTopic = document.getElementById('chat-topic');

        const askGeminiGeneralBtn = document.getElementById('ask-gemini-general');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const aiSubmitBtn = document.getElementById('ai-submit-btn');
        const aiResponseContainer = document.getElementById('ai-response-container');
        const aiLoader = document.getElementById('ai-loader');
        const aiResponse = document.getElementById('ai-response');
        const aiPromptContext = document.getElementById('ai-prompt-context');
        const aiUserQuestion = document.getElementById('ai-user-question');
        
        // --- Navigation ---
        function showScreen(screenId) {
            allScreens.forEach(screen => screen.classList.add('hidden'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');
        }
        
        hubButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');
                showScreen(target);
            });
        });

        homeButtons.forEach(button => {
            button.addEventListener('click', () => {
                showScreen('hub-screen');
                chatInterface.classList.add('hidden');
                chatSetup.style.display = 'block';
            });
        });

        // --- Gemini API Call ---
        function markdownToHtml(markdown) {
            return markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/## (.*)/g, '<h3 class="text-lg font-bold text-[#654321] mt-4 mb-2">$1</h3>')
                .replace(/\* (.*)/g, '<li>$1</li>')
                .replace(/(^|\n)(<li>.*<\/li>)/g, '$1<ul class="list-disc list-inside space-y-1 pr-4">$2</ul>') // Wrap LIs in UL
                .replace(/<\/ul>\n<ul/g, '') // Merge adjacent lists
                .replace(/(\r\n|\n|\r)/gm, '<br>')
                .replace(/<br><h3/g, '<h3')
                .replace(/<br><li>/g, '<li>');
        }
        
        async function callGemini(prompt, systemInstruction = '', jsonResponse = false) {
             const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                return jsonResponse 
                    ? JSON.stringify({ is_correct: false, explanation: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©." })
                    : "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.";
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (systemInstruction) payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            if (jsonResponse) payload.generationConfig = { responseMimeType: "application/json" };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message);
                }

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || (jsonResponse ? '{}' : "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø©.");
            } catch (error) {
                console.error("Gemini API Error:", error);
                return jsonResponse 
                    ? JSON.stringify({ is_correct: false, explanation: `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}` })
                    : `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`;
            }
        }
        
        // --- Quiz Functions ---
        function populateSelectors(selector) {
            selector.innerHTML = '';
            const uniquePages = [...new Set(vocabulary.map(item => item.page))].sort((a,b) => a-b);
            uniquePages.forEach(pageNumber => {
                const option = document.createElement('option');
                option.value = pageNumber;
                option.textContent = `Ø§Ù„ØµÙØ­Ø© ${pageNumber}`;
                selector.appendChild(option);
            });
        }

        function startQuiz() {
            quizSettings = {
                language: document.querySelector('input[name="language"]:checked').value,
                testType: document.querySelector('input[name="testType"]:checked').value,
                page: parseInt(pageSelect.value),
            };
            currentQuizData = vocabulary.filter(word => word.page === quizSettings.page);
            if(currentQuizData.length === 0) return alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª.');
            
            currentQuizData.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            mistakes = [];
            score = 0;
            updateMistakesList();

            showScreen('quiz-screen');
            displayQuestion();
        }

        function displayQuestion() {
            const item = currentQuizData[currentQuestionIndex];
            questionCounter.textContent = `${currentQuestionIndex + 1} / ${currentQuizData.length}`;
            answerInput.value = '';
            feedbackMessage.style.display = 'none';
            answerInput.disabled = false;
            checkAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            
            const btnText = checkAnswerBtn.querySelector('.btn-text');
            const btnLoader = checkAnswerBtn.querySelector('.btn-loader');
            btnText.style.display = 'inline';
            if(btnLoader) btnLoader.classList.add('hidden');
            checkAnswerBtn.disabled = false;

            if (quizSettings.language === 'ar_to_de') {
                questionPrompt.textContent = 'Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØŸ';
                questionText.textContent = item.arabic;
                questionText.dir = 'rtl';
                answerInput.dir = 'ltr';
            } else {
                questionPrompt.textContent = 'Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØŸ';
                questionText.textContent = item.german;
                questionText.dir = 'ltr';
                answerInput.dir = 'rtl';
            }
             answerInput.focus();
        }

        async function checkAnswer() {
            if (!localStorage.getItem('geminiApiKey')) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø°ÙƒÙŠ.");
                return;
            }
            const userAnswer = answerInput.value.trim();
            if(!userAnswer) return;

            const currentItem = currentQuizData[currentQuestionIndex];
            
            const btnText = checkAnswerBtn.querySelector('.btn-text');
            const btnLoader = checkAnswerBtn.querySelector('.btn-loader');
            btnText.style.display = 'none';
            if(btnLoader) btnLoader.classList.remove('hidden'); else {
                const newLoader = document.createElement('div');
                newLoader.className = 'btn-loader';
                checkAnswerBtn.appendChild(newLoader);
            }
            checkAnswerBtn.disabled = true;
            answerInput.disabled = true;

            const langDirection = (quizSettings.language === 'ar_to_de') ? "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©" : "Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
            const question = (quizSettings.language === 'ar_to_de') ? currentItem.arabic : currentItem.german;
            const expectedAnswer = (quizSettings.language === 'ar_to_de') ? currentItem.german : currentItem.arabic;

            const validationPrompt = `
                Ø£Ù†Øª Ù…ØµØ­Ø­ Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©. Ù‚ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨.
                - Ø§Ù„Ø³Ø¤Ø§Ù„: ØªØ±Ø¬Ù… "${question}" (${langDirection}).
                - Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: "${expectedAnswer}".
                - Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: "${userAnswer}".

                Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:
                1. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ØµØ­ÙŠØ­Ø© ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ø£Ùˆ Ù…Ø±Ø§Ø¯ÙØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ØŒ Ø£Ùˆ ØªØªØ¶Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© ØªØ¹Ø±ÙŠÙ/ØªÙ†ÙƒÙŠØ± ØµØ­ÙŠØ­Ø© (Ù…Ø«Ù„ der, die, das, ein, eine)ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ ØµØ­ÙŠØ­Ø©.
                2. Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØºÙŠØ± Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØºØ§Ø¶ÙŠ Ø¹Ù†Ù‡Ø§ ÙˆØ§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.
                3. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©ØŒ Ø§Ø´Ø±Ø­ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.

                ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ø¯ ÙÙ‚Ø· Ø¨ØµÙŠØºØ© JSON ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ÙŠÙ†: "is_correct" (boolean) Ùˆ "explanation" (string Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©).
            `;

            let isCorrect, explanation;
            try {
                const resultJson = await callGemini(validationPrompt, '', true);
                const result = JSON.parse(resultJson);
                isCorrect = result.is_correct;
                explanation = result.explanation;
            } catch (e) {
                console.error("AI validation failed, falling back to simple check.", e);
                const correctAnswers = expectedAnswer.split('/').map(ans => ans.trim().toLowerCase());
                isCorrect = correctAnswers.includes(userAnswer.toLowerCase());
                explanation = isCorrect ? "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!" : `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${expectedAnswer}`;
            }

            btnText.style.display = 'inline';
            checkAnswerBtn.querySelector('.btn-loader').classList.add('hidden');
            
            feedbackMessage.style.display = 'block';

            if (isCorrect) {
                score++;
                feedbackMessage.innerHTML = `<strong>${explanation || 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!'}</strong>`;
                feedbackMessage.className = 'feedback feedback-correct';
            } else {
                feedbackMessage.innerHTML = `<strong>${explanation}</strong>`;
                feedbackMessage.className = 'feedback feedback-incorrect';
                
                if (!mistakes.some(m => m.german === currentItem.german)) {
                    mistakes.push(currentItem);
                }
                updateMistakesList();
            }

            checkAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            nextQuestionBtn.focus();
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizData.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }
        function showResults() {
            showScreen('results-screen');
            resultsSummary.textContent = `Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${score} Ù…Ù† ${currentQuizData.length} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.`;
            if (mistakes.length > 0) reviewPrompt.classList.remove('hidden'); else reviewPrompt.classList.add('hidden');
        }
        function updateMistakesList() {
            mistakesList.innerHTML = '';
            if (mistakes.length > 0) {
                mistakesContainer.classList.remove('hidden');
                mistakes.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'mistake-item p-3 rounded-md flex justify-between items-center';
                    div.innerHTML = `<span class="font-bold text-[#654321]" dir="ltr">${item.german}</span> - <span class="text-[#8C7B62]">${item.arabic}</span>`;
                    mistakesList.appendChild(div);
                });
            } else {
                mistakesContainer.classList.add('hidden');
            }
        }
         function addNewWord() {
            const german = document.getElementById('new-german').value.trim();
            const arabic = document.getElementById('new-arabic').value.trim();
            const page = parseInt(document.getElementById('new-page').value);
            if (!german || !arabic || !page) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ ÙˆÙ…Ø¹Ù†Ø§Ù‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            vocabulary.push({ german, arabic, page });
            ['new-german', 'new-arabic', 'new-page'].forEach(id => document.getElementById(id).value = '');
            addWordSuccess.style.display = 'block';
            setTimeout(() => { addWordSuccess.style.display = 'none'; }, 2000);
            [pageSelect, storyPages, chatPages].forEach(populateSelectors);
        }
        async function generateStory() {
            const selectedPages = Array.from(storyPages.selectedOptions).map(opt => parseInt(opt.value));
            if (selectedPages.length === 0) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            const level = storyLevel.value;
            const words = vocabulary.filter(v => selectedPages.includes(v.page)).map(v => v.german).join(', ');
            storyOutputContainer.classList.remove('hidden');
            storyLoader.style.display = 'flex';
            storyOutput.innerHTML = '';
            const prompt = `Ø§ÙƒØªØ¨ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ø¨ØªÙƒØ±Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© Ø¨Ù…Ø³ØªÙˆÙ‰ ${level}. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${words}. Ø¨Ø¹Ø¯ Ø§Ù„Ù‚ØµØ©ØŒ Ù‚Ù… Ø¨ØªØ±Ø¬Ù…ØªÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            const systemInstruction = `Ø£Ù†Øª ÙƒØ§ØªØ¨ Ù‚ØµØµ ÙˆÙ…Ø¯Ø±Ø³ Ù„ØºØ© Ø£Ù„Ù…Ø§Ù†ÙŠØ©. Ù†Ø³Ù‚ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù‚ØµØ©ØŒ Ø«Ù… Ù†Øµ Ø§Ù„Ù‚ØµØ© Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØŒ Ø«Ù… Ø¹Ù†ÙˆØ§Ù† "Ø§Ù„ØªØ±Ø¬Ù…Ø©"ØŒ Ø«Ù… Ù†Øµ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            const result = await callGemini(prompt, systemInstruction);
            storyOutput.innerHTML = markdownToHtml(result);
            storyLoader.style.display = 'none';
        }
        
        async function startChat() {
            const selectedPages = Array.from(chatPages.selectedOptions).map(opt => parseInt(opt.value));
            const topic = chatTopic.value.trim();

            if (selectedPages.length === 0 && !topic) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙØ­Ø§Øª Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.');
                return;
            }

            const level = chatLevel.value;
            const role = chatRole.value;
            
            let focusContent;
            if (topic) {
                focusContent = `Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù‡Ùˆ "${topic}"`;
            } else {
                const words = vocabulary.filter(v => selectedPages.includes(v.page)).map(v => `"${v.german}" (${v.arabic})`).join(', ');
                focusContent = `Ù‡Ø¯ÙÙ†Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¯Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¹Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${words}`;
            }

            chatSetup.style.display = 'none';
            chatInterface.classList.remove('hidden');
            chatMessages.innerHTML = '';
            chatLoader.style.display = 'flex';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            
            chatHistory = [];

            const initialPrompt = `Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©. Ø£Ù†Ø§ Ø·Ø§Ù„Ø¨ Ø¨Ù…Ø³ØªÙˆÙ‰ ${level}. ØªÙ‚Ù…Øµ Ø¯ÙˆØ± "${role}". ${focusContent}. Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ù…Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¨Ø³ÙŠØ·Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© ÙˆØ§Ø·Ø±Ø­ Ø¹Ù„ÙŠÙ‘ Ø³Ø¤Ø§Ù„Ø§Ù‹. Ù„Ø§ ØªØ°ÙƒØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø±Ø¯Ùƒ Ø§Ù„Ø£ÙˆÙ„.`;
            
            const firstAiMessage = await callGemini(initialPrompt, "Ø£Ù†Øª Ù…Ø¯Ø±Ø¨ Ù„ØºØ© Ø£Ù„Ù…Ø§Ù†ÙŠØ© ØªØªÙ‚Ù…Øµ Ø£Ø¯ÙˆØ§Ø±Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ©.");
            
            addMessageToChat(firstAiMessage, 'ai');
            chatHistory.push({ role: "model", parts: [{ text: firstAiMessage }] });
            
            chatLoader.style.display = 'none';
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.focus();
        }

        function addMessageToChat(text, sender) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-3 rounded-lg ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            bubble.textContent = text;
            if (sender === 'ai') bubble.dir = 'ltr';
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const userInput = chatInput.value.trim();
            if(!userInput) return;
            addMessageToChat(userInput, 'user');
            chatInput.value = '';
            chatLoader.style.display = 'flex';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });

            const systemInstruction = `Ø£Ù†Øª Ù…Ø¯Ø±Ø¨ Ù„ØºØ© Ø£Ù„Ù…Ø§Ù†ÙŠØ© ØªØªÙ‚Ù…Øµ Ø¯ÙˆØ±Ø§Ù‹. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¨Ø³Ø§Ø·Ø© Ø§Ù„Ù„ØºØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨ A1 Ø£Ùˆ A2. ØµØ­Ø­ Ø£Ø®Ø·Ø§Ø¦ÙŠ Ø¨Ù„Ø·Ù ÙˆØ§Ù‚ØªØ±Ø­ Ø·Ø±Ù‚Ù‹Ø§ Ø£ÙØ¶Ù„ Ù„Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ù…Ù„Ø©.`;
            
            const promptForApi = { contents: chatHistory, systemInstruction: { parts: [{ text: systemInstruction }] } };

            const resultText = await callGemini(JSON.stringify(promptForApi)); // This seems wrong, should not stringify the whole object. Let's fix it.
            
            // Correct API call logic for conversation
            const apiKey = localStorage.getItem('geminiApiKey');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const resultTextFromApi = await callApiWithPayload(apiUrl, { contents: chatHistory, systemInstruction: { parts: [{ text: systemInstruction }] } });

            addMessageToChat(resultTextFromApi, 'ai');
            chatHistory.push({ role: "model", parts: [{ text: resultTextFromApi }] });
            
            chatLoader.style.display = 'none';
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.focus();
        }

        async function callApiWithPayload(apiUrl, payload) {
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error.message}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§.";
            } catch (error) {
                return `Ø®Ø·Ø£: ${error.message}`;
            }
        }
        
        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('hub-screen');
            [pageSelect, storyPages, chatPages].forEach(populateSelectors);
            checkApiKey();

            startQuizBtn.addEventListener('click', startQuiz);
            checkAnswerBtn.addEventListener('click', checkAnswer);
            nextQuestionBtn.addEventListener('click', nextQuestion);
            newQuizBtn.addEventListener('click', () => showScreen('setup-screen'));
            addWordBtn.addEventListener('click', addNewWord);
            generateStoryBtn.addEventListener('click', generateStory);
            startChatBtn.addEventListener('click', startChat);
            chatSendBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            
            closePanelBtn.addEventListener('click', closeAiPanel);
            aiPanelOverlay.addEventListener('click', (e) => { if(e.target === aiPanelOverlay) closeAiPanel(); });
            
            saveApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                } else {
                    localStorage.removeItem('geminiApiKey');
                }
                checkApiKey();
            });

            askGeminiGeneralBtn.addEventListener('click', () => {
                if(!localStorage.getItem('geminiApiKey')) {
                    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.");
                    return;
                }
                const currentItem = currentQuizData[currentQuestionIndex];
                const context = `Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© "${currentItem.german}" Ø§Ù„ØªÙŠ ØªØ¹Ù†ÙŠ "${currentItem.arabic}".`;
                const prefilled = `Ø§Ø´Ø±Ø­ Ù„ÙŠ Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© "${currentItem.german}". Ù…Ø§ Ù‡ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§ØªÙ‡Ø§ Ø£Ùˆ Ø£ÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø®Ø§ØµØ© Ø¨Ù‡Ø§ØŸ`;
                openAiPanel(context, prefilled);
            });

            aiSubmitBtn.addEventListener('click', async () => {
                const userQuestion = aiUserQuestion.value;
                if (!userQuestion) return;
                
                const fullPrompt = `${aiPromptContext.textContent}\n\nØ³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userQuestion}`;
                const systemInstruction = `Ø£Ù†Øª Ù…Ø¯Ø±Ø³ Ø®Ø¨ÙŠØ± ÙˆÙ„Ø·ÙŠÙ Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©. Ù‚Ù… Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¨ÙˆØ¶ÙˆØ­ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ†. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ù…Ø«Ù„ ## Ø¹Ù†ÙˆØ§Ù†)ØŒ ÙˆØ§Ù„Ù†Ù‚Ø§Ø· (Ø³Ø·Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ù€ * )ØŒ ÙˆØ§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±ÙŠØ¶ (**Ù†Øµ Ø¹Ø±ÙŠØ¶**) Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø±Ø­ Ø³Ù‡Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙÙ‡Ù….`;
                
                aiResponseContainer.classList.remove('hidden');
                aiLoader.style.display = 'flex';
                aiResponse.innerHTML = '';
                
                const result = await callGemini(fullPrompt, systemInstruction);
                aiResponse.innerHTML = markdownToHtml(result);
                aiLoader.style.display = 'none';
            });

             answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!checkAnswerBtn.classList.contains('hidden')) checkAnswerBtn.click();
                    else if (!nextQuestionBtn.classList.contains('hidden')) nextQuestionBtn.click();
                }
            });

        });

        function checkApiKey() {
            const key = localStorage.getItem('geminiApiKey');
            const aiButtons = [hubStoryBtn, hubChatBtn, askGeminiGeneralBtn, checkAnswerBtn];
            const aiDependentFeatures = [generateStoryBtn, startChatBtn, aiSubmitBtn];
            
            if (key) {
                apiKeyInput.value = key;
                apiKeyStatus.textContent = 'Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….';
                apiKeyStatus.className = 'text-center font-semibold text-green-700';
                aiButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.title = '';
                });
                aiDependentFeatures.forEach(btn => {
                    btn.disabled = false;
                    btn.title = '';
                });
            } else {
                apiKeyStatus.textContent = 'Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¹Ø·Ù„Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API.';
                apiKeyStatus.className = 'text-center font-semibold text-red-700';
                 aiButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.title = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©';
                });
                 aiDependentFeatures.forEach(btn => {
                    btn.disabled = true;
                    btn.title = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©';
                });
            }
        }
    </script>
</body>
</html>

